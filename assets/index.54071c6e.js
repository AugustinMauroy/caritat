var ee=Object.defineProperty,te=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var Y=(n,e,t)=>e in n?ee(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,D=(n,e)=>{for(var t in e||(e={}))re.call(e,t)&&Y(n,t,e[t]);if(q)for(var t of q(e))oe.call(e,t)&&Y(n,t,e[t]);return n},F=(n,e)=>te(n,ne(e));import{S as A,i as P,s as S,h as L,e as b,a as k,b as J,c as f,u as K,n as _,d as p,f as W,t as U,g as I,j as w,l as O,k as g,m as T,o as M,p as j,q as z,r as G}from"./vendor.d952fdf1.js";const le=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerpolicy&&(l.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?l.credentials="include":r.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(r){if(r.ep)return;r.ep=!0;const l=t(r);fetch(r.href,l)}};le();function ae(n){var r,l;let e,t=((l=(r=n[4])==null?void 0:r.message)!=null?l:n[4])+"",o;return{c(){e=U("An error occured: "),o=U(t)},m(a,i){f(a,e,i),f(a,o,i)},p(a,i){var s,c;i&1&&t!==(t=((c=(s=a[4])==null?void 0:s.message)!=null?c:a[4])+"")&&I(o,t)},d(a){a&&p(e),a&&p(o)}}}function ie(n){let e,t,o,r,l,a,i,s,c,u={ctx:n,current:null,token:null,hasCatch:!0,pending:ue,then:ce,catch:se,error:4};return L(l=n[1],u),{c(){e=b("textarea"),o=k(),r=b("div"),u.block.c(),a=k(),i=b("button"),i.textContent="Copy to clipboard",e.readOnly=!0,e.value=t=n[3],w(i,"type","button")},m(m,d){f(m,e,d),f(m,o,d),f(m,r,d),u.block.m(r,u.anchor=null),u.mount=()=>r,u.anchor=null,f(m,a,d),f(m,i,d),s||(c=O(i,"click",n[2]),s=!0)},p(m,d){n=m,d&1&&t!==(t=n[3])&&(e.value=t),u.ctx=n,d&2&&l!==(l=n[1])&&L(l,u)||K(u,n,d)},d(m){m&&p(e),m&&p(o),m&&p(r),u.block.d(),u.token=null,u=null,m&&p(a),m&&p(i),s=!1,c()}}}function se(n){var r,l;let e,t=((l=(r=n[4])==null?void 0:r.message)!=null?l:n[4])+"",o;return{c(){e=U("An error occured: "),o=U(t)},m(a,i){f(a,e,i),f(a,o,i)},p(a,i){var s,c;i&2&&t!==(t=((c=(s=a[4])==null?void 0:s.message)!=null?c:a[4])+"")&&I(o,t)},d(a){a&&p(e),a&&p(o)}}}function ce(n){let e;return{c(){e=U("Copied to the clipboard!")},m(t,o){f(t,e,o)},p:_,d(t){t&&p(e)}}}function ue(n){let e;return{c(){e=U("Copying to the Clipboard\u2026")},m(t,o){f(t,e,o)},p:_,d(t){t&&p(e)}}}function fe(n){let e;return{c(){e=b("textarea"),e.readOnly=!0,e.value="Encrypting data\u2026 "},m(t,o){f(t,e,o)},p:_,d(t){t&&p(e)}}}function pe(n){let e,t,o,r,l={ctx:n,current:null,token:null,hasCatch:!0,pending:fe,then:ie,catch:ae,value:3,error:4};return L(r=n[0],l),{c(){e=b("summary"),e.textContent="Get encrypted ballot",t=k(),o=J(),l.block.c()},m(a,i){f(a,e,i),f(a,t,i),f(a,o,i),l.block.m(a,l.anchor=i),l.mount=()=>o.parentNode,l.anchor=o},p(a,[i]){n=a,l.ctx=n,i&1&&r!==(r=n[0])&&L(r,l)||K(l,n,i)},i:_,o:_,d(a){a&&p(e),a&&p(t),a&&p(o),l.block.d(a),l.token=null,l=null}}}function me(n,e,t){let{encryptDataPromise:o}=e,r;function l(){t(1,r=o.then(a=>navigator.clipboard.writeText(a)))}return W(l),n.$$set=a=>{"encryptDataPromise"in a&&t(0,o=a.encryptDataPromise)},[o,r,l]}class de extends A{constructor(e){super();P(this,e,me,pe,S,{encryptDataPromise:0})}}const Q={name:"RSA-OAEP",hash:"SHA-256"},E={name:"AES-CBC",length:256,saltSize:8},$={name:"PBKDF2",hash:"SHA-256",iterations:1e5,keySize:32,ivSize:16};var ye=crypto;const{subtle:R}=crypto;async function be(n,e,...t){const o=await R.importKey("raw",n,$.name,!1,["deriveBits"]),r=await R.deriveBits(F(D({},$),{salt:e}),o,8*($.ivSize+$.keySize)),l=await R.importKey("raw",new Uint8Array(r,0,$.keySize),E,!1,t),a=new Uint8Array(r,$.keySize);return{key:l,iv:a}}const he=new TextDecoder;function _e(n){const e=new ArrayBuffer(n.length),t=new Uint8Array(e);for(let o=0,r=n.length;o<r;o++)t[o]=n.charCodeAt(o);return e}function we(n,e,t){typeof e!="string"&&(e=he.decode(e));const o=e.split("-----",3)[2].replace(/\s+/g,""),r=atob(o),l=_e(r);return R.importKey(n,l,Q,!0,t)}function ve(n,e){return we(e?"pkcs8":"spki",n,[e?"decrypt":"encrypt"])}const B=[83,97,108,116,101,100,95,95];async function ke(n,e){const t=await R.exportKey("raw",await R.generateKey(E,!0,["encrypt"])),o=ye.getRandomValues(new Uint8Array(E.saltSize)),r=await ve(e);console.log({secret:t,salt:o});const l=await R.encrypt({name:Q.name},r,t),{iv:a,key:i}=await be(t,o,"encrypt"),s=await R.encrypt(F(D({},E),{iv:a}),i,n),c=new Uint8Array(B.length+E.saltSize+s.byteLength);return c.set(B),c.set(o,B.length),c.set(new Uint8Array(s),B.length+E.saltSize),{encryptedSecret:l,data:c}}function X(n){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=n.byteLength,r=o%3,l=o-r,a,i,s,c,u,m=0;m<l;m=m+3)u=n[m]<<16|n[m+1]<<8|n[m+2],a=(u&16515072)>>18,i=(u&258048)>>12,s=(u&4032)>>6,c=u&63,e+=t[a]+t[i]+t[s]+t[c];return r==1?(u=n[l],a=(u&252)>>2,i=(u&3)<<4,e+=t[a]+t[i]+"=="):r==2&&(u=n[l]<<8|n[l+1],a=(u&64512)>>10,i=(u&1008)>>4,s=(u&15)<<2,e+=t[a]+t[i]+t[s]+"="),e}const ge=/^\/([^/]+)\/([^/]+)\/pull\/(\d+)\/?$/,Ue=new URL("https://raw.githubusercontent.com/");async function Le(n){var s;const e=new URL(n);if(e.origin!=="https://github.com")throw new Error("Only GitHub PR URLs are supported on the web UI. Use the CLI instead.");const t=ge.exec(e.pathname);if(t==null)throw new Error("Only GitHub PR URLs are supported on the web UI. Use the CLI instead.");const[,o,r,l]=t,i=(s=(await fetch(`https://api.github.com/repos/${o}/${r}/pulls/${l}/files`).then(c=>c.ok?c.json():Promise.reject(new Error(`Fetch error: ${c.status} ${c.statusText}`)))).find(c=>c.filename.endsWith("/vote.yml")))==null?void 0:s.raw_url;if(!i)throw new Error("Failed to find a vote.yml file in this PR");return new URL(new URL(i).pathname.replace("/raw/","/"),Ue)}let N=new Map;async function Re(n){const e=N.get(n);if(console.log({cachedRequest:e,url:n}),e!=null)return e;try{const t=Le(n);return N.set(n,t),t}catch(t){throw N.set(n,Promise.reject(t)),t}}async function Ce(n){try{const e=await Re(n),t=new URL("./ballot.yml",e),o=new URL("./public.pem",e);return[fetch(t).then(r=>r.ok?r.text():Promise.reject(new Error(`Fetch error: ${r.status} ${r.statusText}`))),fetch(o).then(r=>r.ok?r.arrayBuffer():Promise.reject(new Error(`Fetch error: ${r.status} ${r.statusText}`)))]}catch(e){return e=Promise.reject(e),[e,e]}}let Z;function Ee(n,e){Z!==n&&(Z=n,Ce(n).then(e,e))}function $e(n){var l,a;let e,t,o=((a=(l=n[7])==null?void 0:l.message)!=null?a:n[7])+"",r;return{c(){e=b("p"),t=U("An error occured: "),r=U(o)},m(i,s){f(i,e,s),g(e,t),g(e,r)},p(i,s){var c,u;s&1&&o!==(o=((u=(c=i[7])==null?void 0:c.message)!=null?u:i[7])+"")&&I(r,o)},d(i){i&&p(e)}}}function Ae(n){let e,t,o,r,l,a,i,s={ctx:n,current:null,token:null,hasCatch:!1,pending:Be,then:Se,catch:Pe};return L(l=n[1],s),{c(){e=b("form"),t=b("textarea"),r=k(),s.block.c(),w(t,"name","ballot"),t.value=o=n[6]},m(c,u){f(c,e,u),g(e,t),g(e,r),s.block.m(e,s.anchor=null),s.mount=()=>e,s.anchor=null,a||(i=O(e,"submit",n[2]),a=!0)},p(c,u){n=c,u&1&&o!==(o=n[6])&&(t.value=o),s.ctx=n,u&2&&l!==(l=n[1])&&L(l,s)},d(c){c&&p(e),s.block.d(),s.token=null,s=null,a=!1,i()}}}function Pe(n){return{c:_,m:_,d:_}}function Se(n){let e;return{c(){e=b("button"),e.textContent="Encrypt ballot",w(e,"type","submit")},m(t,o){f(t,e,o)},d(t){t&&p(e)}}}function Be(n){let e;return{c(){e=b("button"),e.textContent="Loading public key\u2026",w(e,"type","submit"),e.disabled=!0},m(t,o){f(t,e,o)},d(t){t&&p(e)}}}function De(n){let e;return{c(){e=b("p"),e.textContent="...loading"},m(t,o){f(t,e,o)},p:_,d(t){t&&p(e)}}}function Fe(n){let e,t,o,r,l={ctx:n,current:null,token:null,hasCatch:!0,pending:De,then:Ae,catch:$e,value:6,error:7};return L(r=n[0],l),{c(){e=b("summary"),e.textContent="Fill in ballot",t=k(),o=J(),l.block.c()},m(a,i){f(a,e,i),f(a,t,i),f(a,o,i),l.block.m(a,l.anchor=i),l.mount=()=>o.parentNode,l.anchor=o},p(a,[i]){n=a,l.ctx=n,i&1&&r!==(r=n[0])&&L(r,l)||K(l,n,i)},i:_,o:_,d(a){a&&p(e),a&&p(t),a&&p(o),l.block.d(a),l.token=null,l=null}}}function Ke(n,e,t){let{url:o,registerEncrypedBallot:r}=e,l,a;const i=typeof TextEncoder=="undefined"?{encode(){}}:new TextEncoder;function s(c){c.preventDefault();const u=this.elements.namedItem("ballot");r((async()=>{const{encryptedSecret:m,data:d}=await ke(i.encode(u.value),await a);return JSON.stringify({encryptedSecret:X(new Uint8Array(m)),data:X(d)})})())}return l=a=Promise.reject("no data"),W(()=>{Ee(o,c=>{t(0,[l,a]=c,l,t(1,a))})}),n.$$set=c=>{"url"in c&&t(3,o=c.url),"registerEncrypedBallot"in c&&t(4,r=c.registerEncrypedBallot)},[l,a,s,o,r]}class Ie extends A{constructor(e){super();P(this,e,Ke,Fe,S,{url:3,registerEncrypedBallot:4})}}function Oe(n){let e,t,o,r,l,a,i,s,c,u,m;return{c(){e=b("summary"),e.textContent="Get URL to load the data",t=k(),o=b("form"),r=b("div"),l=b("label"),a=U(`URL:
      `),i=b("input"),s=k(),c=b("input"),w(i,"type","url"),i.value=n[0],w(i,"name","url"),w(i,"class","svelte-xat9pf"),w(l,"class","svelte-xat9pf"),w(c,"type","submit"),c.value="Load data",w(r,"class","svelte-xat9pf"),w(o,"class","svelte-xat9pf")},m(d,v){f(d,e,v),f(d,t,v),f(d,o,v),g(o,r),g(r,l),g(l,a),g(l,i),g(r,s),g(r,c),u||(m=O(o,"submit",Te),u=!0)},p(d,[v]){v&1&&i.value!==d[0]&&(i.value=d[0])},i:_,o:_,d(d){d&&p(e),d&&p(t),d&&p(o),u=!1,m()}}}function Te(n){n.preventDefault(),globalThis.location.hash=this.elements.namedItem("url").value}function Me(n,e,t){let{url:o}=e;return n.$$set=r=>{"url"in r&&t(0,o=r.url)},[o]}class je extends A{constructor(e){super();P(this,e,Me,Oe,S,{url:0})}}function ze(n){let e,t,o,r,l,a,i,s,c,u,m,d,v,C;return r=new je({props:{url:n[1]}}),s=new Ie({props:{url:n[1],registerEncrypedBallot:n[3]}}),d=new de({props:{encryptDataPromise:n[0]}}),{c(){e=b("h1"),e.textContent="Caritat",t=k(),o=b("details"),T(r.$$.fragment),a=k(),i=b("details"),T(s.$$.fragment),u=k(),m=b("details"),T(d.$$.fragment),o.open=l=n[2]===0,i.open=c=n[2]===1,m.open=v=n[2]===2},m(y,h){f(y,e,h),f(y,t,h),f(y,o,h),M(r,o,null),f(y,a,h),f(y,i,h),M(s,i,null),f(y,u,h),f(y,m,h),M(d,m,null),C=!0},p(y,[h]){const x={};h&2&&(x.url=y[1]),r.$set(x),(!C||h&4&&l!==(l=y[2]===0))&&(o.open=l);const H={};h&2&&(H.url=y[1]),s.$set(H),(!C||h&4&&c!==(c=y[2]===1))&&(i.open=c);const V={};h&1&&(V.encryptDataPromise=y[0]),d.$set(V),(!C||h&4&&v!==(v=y[2]===2))&&(m.open=v)},i(y){C||(j(r.$$.fragment,y),j(s.$$.fragment,y),j(d.$$.fragment,y),C=!0)},o(y){z(r.$$.fragment,y),z(s.$$.fragment,y),z(d.$$.fragment,y),C=!1},d(y){y&&p(e),y&&p(t),y&&p(o),G(r),y&&p(a),y&&p(i),G(s),y&&p(u),y&&p(m),G(d)}}}function Ge(n,e,t){var i;let o=Promise.reject("no data received"),r=(i=globalThis.location)==null?void 0:i.hash.slice(1),l=r?1:0;addEventListener("hashchange",()=>{var s;t(1,r=(s=globalThis.location)==null?void 0:s.hash.slice(1)),t(2,l=r?Math.max(l,1):0)});function a(s){t(0,o=s),s.then(()=>{t(2,l=2)},()=>{t(2,l=Math.min(l,1))})}return[o,r,l,a]}class Ne extends A{constructor(e){super();P(this,e,Ge,ze,S,{})}}new Ne({target:document.getElementById("app")});
